<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-dark sidebar">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#dashboard-section" data-section="dashboard">
                                <span data-feather="home"></span>
                                Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#active-chats-section" data-section="active-chats">
                                <span data-feather="message-square"></span>
                                Active Chats
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#chat-history-section" data-section="chat-history">
                                <span data-feather="archive"></span>
                                Chat History
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#tasks-section" data-section="tasks">
                                <span data-feather="check-square"></span>
                                Tasks
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#analytics-section" data-section="analytics">
                                <span data-feather="bar-chart-2"></span>
                                Analytics
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#operators-section" data-section="operators">
                                <span data-feather="users"></span>
                                Operators
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#companies-section" data-section="companies">
                                <span data-feather="briefcase"></span>
                                Companies
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="workflow-editor.html" target="_blank">
                                <span data-feather="git-branch"></span>
                                Workflow Editor
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#settings-section" data-section="settings">
                                <span data-feather="settings"></span>
                                Settings
                            </a>
                        </li>
                    </ul>
                    <div class="sidebar-profile text-center mt-4">
                        <div id="profile-name"></div>
                        <div id="profile-email" class="small"></div>
                        <button class="btn btn-sm btn-outline-light mt-2" id="logout-btn">Logout</button>
                    </div>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <button class="btn btn-dark d-md-none me-2" id="sidebarToggle">
                            <span data-feather="menu"></span>
                        </button>
                        Chatbot Admin Dashboard
                    </h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary">Export</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary">Settings</button>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Section -->
                <section id="dashboard-section" class="content-section active">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Active Chats</h5>
                                    <h1 class="display-4" id="active-chats-count">0</h1>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Total Chats Today</h5>
                                    <h1 class="display-4" id="total-chats-today">0</h1>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Average Response Time</h5>
                                    <h1 class="display-4" id="avg-response-time">0s</h1>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Chat Activity (Last 7 Days)</h5>
                                    <canvas id="chat-activity-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Common Topics</h5>
                                    <canvas id="topics-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Active Chats Section -->
                <section id="active-chats-section" class="content-section">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    Active Conversations
                                </div>
                                <div class="list-group list-group-flush" id="active-chat-list">
                                    <a href="#" class="list-group-item list-group-item-action empty-state">No active conversations</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <span id="selected-chat-title">Select a conversation</span>
                                    <div class="float-end">
                                        <button class="btn btn-sm btn-primary" id="join-chat-btn" disabled>Join Chat</button>
                                        <button class="btn btn-sm btn-success" id="create-task-btn" disabled>Create Task</button>
                                        <button class="btn btn-sm btn-info" id="view-tasks-btn" disabled>View Tasks</button>
                                        <button class="btn btn-sm btn-warning" id="leave-chat-btn" disabled>Leave Chat</button>
                                        <button class="btn btn-sm btn-danger" id="end-chat-btn" disabled>End Chat</button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- User Contact Information -->
                                    <div id="user-contact-info" class="mb-3" style="display: none;">
                                        <div class="card">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <h6 class="mb-0">User Contact Information</h6>
                                                <div>
                                                    <button class="btn btn-sm btn-outline-secondary me-2" id="request-user-info-btn">Request Info</button>
                                                    <button class="btn btn-sm btn-outline-primary" id="edit-contact-info-btn">Edit</button>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <p><strong>Name:</strong> <span id="user-name">Not provided</span></p>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <p><strong>Email:</strong> <span id="user-email">Not provided</span></p>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <p><strong>Phone:</strong> <span id="user-phone">Not provided</span></p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="chat-messages" class="chat-messages">
                                        <div class="empty-state">
                                            <p>Select a conversation to view messages</p>
                                        </div>
                                    </div>
                                    <div id="operator-input" class="mt-3" style="display: none;">
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="operator-message" placeholder="Type your message...">
                                            <button class="btn btn-primary" id="send-operator-message">Send</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Chat History Section -->
                <section id="chat-history-section" class="content-section">
                    <div class="card">
                        <div class="card-header">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5>Chat History</h5>
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="chat-history-search" placeholder="Search conversations...">
                                        <button class="btn btn-outline-secondary" type="button" id="chat-history-search-btn">Search</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>Session ID</th>
                                            <th>Date</th>
                                            <th>Duration</th>
                                            <th>Messages</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="chat-history-table">
                                        <tr>
                                            <td colspan="6" class="text-center">No chat history available</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Analytics Section -->
                <section id="analytics-section" class="content-section">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Chat Volume Over Time</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="chat-volume-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Average Response Time</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="response-time-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Conversation Metrics</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Metric</th>
                                                    <th>Today</th>
                                                    <th>This Week</th>
                                                    <th>This Month</th>
                                                    <th>Change</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>Total Conversations</td>
                                                    <td id="conv-total-today">0</td>
                                                    <td id="conv-total-week">0</td>
                                                    <td id="conv-total-month">0</td>
                                                    <td id="conv-total-change">0%</td>
                                                </tr>
                                                <tr>
                                                    <td>Average Duration</td>
                                                    <td id="conv-duration-today">0 min</td>
                                                    <td id="conv-duration-week">0 min</td>
                                                    <td id="conv-duration-month">0 min</td>
                                                    <td id="conv-duration-change">0%</td>
                                                </tr>
                                                <tr>
                                                    <td>Messages per Conversation</td>
                                                    <td id="conv-msgs-today">0</td>
                                                    <td id="conv-msgs-week">0</td>
                                                    <td id="conv-msgs-month">0</td>
                                                    <td id="conv-msgs-change">0%</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Tasks Section -->
                <section id="tasks-section" class="content-section">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h5>Task Management</h5>
                                        </div>
                                        <div class="col-md-6 text-end">
                                            <button class="btn btn-primary" id="new-task-btn">New Task</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <div class="task-filters">
                                                <div class="row">
                                                    <div class="col-md-3">
                                                        <select class="form-select" id="task-status-filter">
                                                            <option value="">All Statuses</option>
                                                            <option value="open">Open</option>
                                                            <option value="in_progress">In Progress</option>
                                                            <option value="completed">Completed</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <select class="form-select" id="task-priority-filter">
                                                            <option value="">All Priorities</option>
                                                            <option value="low">Low</option>
                                                            <option value="medium">Medium</option>
                                                            <option value="high">High</option>
                                                            <option value="urgent">Urgent</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <select class="form-select" id="task-assignee-filter">
                                                            <option value="">All Assignees</option>
                                                            <!-- Assignees will be populated dynamically -->
                                                        </select>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="input-group">
                                                            <input type="text" class="form-control" id="task-search" placeholder="Search tasks...">
                                                            <button class="btn btn-outline-secondary" type="button" id="task-search-btn">Search</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="table-responsive task-table-container">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Title</th>
                                                    <th>Description</th>
                                                    <th>Due Date</th>
                                                    <th>Priority</th>
                                                    <th>Assignee</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="task-list">
                                                <tr>
                                                    <td colspan="7" class="text-center">No tasks available</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Task Detail View -->
                    <div class="row" id="task-detail-container" style="display: none;">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 id="task-detail-title">Task Details</h5>
                                        <div>
                                            <button class="btn btn-sm btn-primary me-2" id="edit-task-btn">Edit</button>
                                            <button class="btn btn-sm btn-secondary" id="back-to-tasks-btn">Back to Tasks</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <div class="task-info mb-4">
                                                <h4 id="task-title"></h4>
                                                <p id="task-description" class="text-muted"></p>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <p><strong>Due Date:</strong> <span id="task-due-date"></span></p>
                                                        <p><strong>Priority:</strong> <span id="task-priority"></span></p>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <p><strong>Assignee:</strong> <span id="task-assignee"></span></p>
                                                        <p><strong>Status:</strong> 
                                                            <select class="form-select form-select-sm d-inline-block w-auto" id="task-status-update">
                                                                <option value="open">Open</option>
                                                                <option value="in_progress">In Progress</option>
                                                                <option value="completed">Completed</option>
                                                            </select>
                                                        </p>
                                                    </div>
                                                </div>
                                                <div class="mt-3">
                                                    <a href="#" id="task-conversation-link" class="btn btn-sm btn-outline-primary">View Original Conversation</a>
                                                    <button id="create-follow-up-btn" class="btn btn-sm btn-outline-success">Create Follow-up</button>
                                                </div>

                                                <!-- Parent Task Info (only shown for follow-up tasks) -->
                                                <div id="parent-task-info" class="alert alert-info mt-3" style="display: none;">
                                                    <p class="mb-0"><strong>This is a follow-up to:</strong> <a href="#" id="parent-task-link"><span id="parent-task-title"></span></a></p>
                                                </div>
                                            </div>

                                            <div class="contact-info mb-4">
                                                <h5>Contact Information</h5>
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <p><strong>Name:</strong> <span id="contact-name"></span></p>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <p><strong>Email:</strong> <span id="contact-email"></span></p>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <p><strong>Phone:</strong> <span id="contact-phone"></span></p>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Follow-up Tasks Section -->
                                            <div id="follow-ups-section" class="mb-4" style="display: none;">
                                                <h5>Follow-up Tasks</h5>
                                                <div id="follow-ups-list" class="mb-3">
                                                    <!-- Follow-up tasks will be populated dynamically -->
                                                </div>
                                            </div>

                                            <div class="task-comments">
                                                <h5>Comments</h5>
                                                <div id="comments-list" class="mb-3">
                                                    <!-- Comments will be populated dynamically -->
                                                    <div class="text-center text-muted">No comments yet</div>
                                                </div>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="comment-input" placeholder="Add a comment...">
                                                    <button class="btn btn-primary" id="add-comment-btn">Add Comment</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h5>Activity</h5>
                                                </div>
                                                <div class="card-body">
                                                    <ul class="list-group" id="task-activity-list">
                                                        <!-- Activity items will be populated dynamically -->
                                                        <li class="list-group-item text-center text-muted">No activity yet</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Operators Section -->
                <section id="operators-section" class="content-section">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>Operator Management</h5>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createOperatorModal">
                                <span data-feather="plus"></span> New Operator
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>Username</th>
                                            <th>Display Name</th>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Status</th>
                                            <th>Created</th>
                                            <th>Last Login</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="operators-table-body">
                                        <!-- Operators will be listed here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Companies Section -->
                <section id="companies-section" class="content-section">
                    <!-- Companies List Section -->
                    <div id="companies-list-section">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>Company Management</h5>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createCompanyModal" id="superadmin-only-btn">
                                    <span data-feather="plus"></span> New Company
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-sm">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Description</th>
                                                <th>Website</th>
                                                <th>Status</th>
                                                <th>Created</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="companies-table-body">
                                            <!-- Companies will be listed here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Company Detail Section -->
                    <div id="company-detail-section">
                        <input type="hidden" id="company-detail-id">
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>Company Details</h5>
                                <button class="btn btn-secondary" id="back-to-companies-btn">
                                    <span data-feather="arrow-left"></span> Back to Companies
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Name:</strong> <span id="company-detail-name"></span></p>
                                        <p><strong>Description:</strong> <span id="company-detail-description"></span></p>
                                        <p><strong>Website:</strong> <span id="company-detail-website"></span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Status:</strong> <span id="company-detail-status"></span></p>
                                        <p><strong>Created:</strong> <span id="company-detail-created"></span></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>Company Users</h5>
                                <button class="btn btn-primary" id="create-company-user-btn">
                                    <span data-feather="plus"></span> New User
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-sm">
                                        <thead>
                                            <tr>
                                                <th>Username</th>
                                                <th>Display Name</th>
                                                <th>Email</th>
                                                <th>Role</th>
                                                <th>Status</th>
                                                <th>Created</th>
                                                <th>Last Login</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="company-users-table-body">
                                            <!-- Company users will be listed here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Settings Section -->
                <section id="settings-section" class="content-section">
                    <div class="card">
                        <div class="card-header">
                            <h5>Dashboard Settings</h5>
                        </div>
                        <div class="card-body">
                            <ul class="nav nav-tabs mb-3" id="settings-tabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general-pane" type="button" role="tab">General</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="knowledge-tab" data-bs-toggle="tab" data-bs-target="#knowledge-pane" type="button" role="tab">Knowledge Base</button>
                                </li>
                            </ul>
                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="general-pane" role="tabpanel">
                                    <form id="settings-form">
                                        <h5 class="mt-0">Notifications</h5>
                                        <div class="mb-3">
                                            <label for="notification-setting" class="form-label">Notifications</label>
                                            <select class="form-select" id="notification-setting">
                                                <option value="all">All notifications</option>
                                                <option value="important">Important only</option>
                                                <option value="none">None</option>
                                            </select>
                                        </div>
                                        <div class="mb-3 form-check">
                                            <input type="checkbox" class="form-check-input" id="sound-notifications">
                                            <label class="form-check-label" for="sound-notifications">Enable sound notifications</label>
                                        </div>
                                        <div class="mb-3">
                                            <label for="auto-refresh" class="form-label">Auto-refresh interval (seconds)</label>
                                            <input type="number" class="form-control" id="auto-refresh" min="5" value="30">
                                        </div>
                                    </form>
                                </div>
                                <div class="tab-pane fade" id="knowledge-pane" role="tabpanel">
                                    <div id="knowledge-management" class="mb-4">
                                        <div class="d-flex mb-2 align-items-center">
                                            <h6 class="me-auto mb-0">Saved Spreadsheets</h6>
                                            <div class="input-group input-group-sm w-auto me-2">
                                                <input type="text" class="form-control" id="knowledge-query" placeholder="Search Saved">
                                                <button class="btn btn-outline-secondary" type="button" id="search-knowledge">Search</button>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="refresh-knowledge">Refresh</button>
                                        </div>
                                        <ul class="list-group mb-3" id="knowledge-list"></ul>
                                    </div>
                                    <div id="kb-step-connect" class="kb-step">
                                        <h5>Connect a Knowledge Source</h5>
                                        <p>Connect a Google Spreadsheet to provide the chatbot with a knowledge base. The chatbot will use the selected data to answer questions.</p>
                                        <button type="button" class="btn btn-primary" id="connect-google">Connect Google Account</button>
                                    </div>
                                    <div id="kb-step-search" class="kb-step d-none">
                                        <h5>Step 1: Find Your Spreadsheet</h5>
                                        <p>Connected as: <span id="google-account"></span> <button class="btn btn-link btn-sm" id="change-google">Disconnect</button></p>
                                        <div class="input-group mb-3">
                                            <input type="text" class="form-control" id="drive-query" placeholder="Search for your spreadsheet by name">
                                            <button class="btn btn-outline-secondary" type="button" id="search-drive">Search</button>
                                        </div>
                                        <ul class="list-group mb-3" id="drive-results"></ul>
                                    </div>
                                    <div id="kb-step-sheet" class="kb-step d-none">
                                        <h5>Step 2: Choose the Sheet</h5>
                                        <p>Selected Spreadsheet: <span id="selected-spreadsheet-name"></span> <button class="btn btn-link btn-sm" id="kb-change-spreadsheet">Change</button></p>
                                        <input type="hidden" id="spreadsheet-id">
                                        <div class="mb-3">
                                            <label for="sheet-select" class="form-label">Sheet</label>
                                            <select class="form-select" id="sheet-select"></select>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="default-sheet" checked>
                                            <label class="form-check-label" for="default-sheet">Use Sheet1 (default)</label>
                                        </div>
                                        <button type="button" class="btn btn-primary" id="load-sheet" disabled>Load Sheet</button>
                                    </div>
                                    <div id="kb-step-columns" class="kb-step d-none">
                                        <h5>Step 3: Select Columns for the Chatbot</h5>
                                        <p>Select the columns the chatbot should use as its knowledge. Only data from these columns will be accessible.</p>
                                        <div class="table-responsive spreadsheet-table-container mb-3">
                                            <table class="table table-striped" id="spreadsheet-table"></table>
                                        </div>
                                        <button type="button" class="btn btn-primary" id="finish-kb-setup">Save Configuration</button>
                                    </div>
                                    <div id="kb-summary" class="kb-step d-none">
                                        <h5>âœ… Knowledge Base Active</h5>
                                        <ul id="kb-summary-details" class="mb-3"></ul>
                                        <button type="button" class="btn btn-outline-secondary me-2" id="kb-refresh">Refresh Data</button>
                                        <button type="button" class="btn btn-outline-secondary me-2" id="kb-edit">Edit Configuration</button>
                                        <button type="button" class="btn btn-outline-danger" id="kb-disconnect">Disconnect</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Create Operator Modal -->
    <div class="modal fade" id="createOperatorModal" tabindex="-1" aria-labelledby="createOperatorModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createOperatorModalLabel">Create New Operator</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="create-operator-form">
                        <div class="mb-3">
                            <label for="operator-username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="operator-username" required>
                        </div>
                        <div class="mb-3">
                            <label for="operator-display-name" class="form-label">Display Name</label>
                            <input type="text" class="form-control" id="operator-display-name">
                        </div>
                        <div class="mb-3">
                            <label for="operator-name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="operator-name">
                            <div class="form-text">Full name of the operator (optional)</div>
                        </div>
                        <div class="mb-3">
                            <label for="operator-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="operator-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="operator-role" class="form-label">Role</label>
                            <select class="form-select" id="operator-role">
                                <option value="operator">Operator</option>
                                <option value="company_admin">Company Admin</option>
                                <option value="superadmin" class="superadmin-only">Superadmin</option>
                            </select>
                        </div>
                        <div class="mb-3" id="company-selection-container">
                            <label for="operator-company" class="form-label">Company</label>
                            <select class="form-select" id="operator-company" required>
                                <option value="">Select a company</option>
                                <!-- Companies will be populated dynamically -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="operator-password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="operator-password" required>
                        </div>
                        <div class="mb-3">
                            <label for="operator-confirm-password" class="form-label">Confirm Password</label>
                            <input type="password" class="form-control" id="operator-confirm-password" required>
                        </div>
                        <div class="alert alert-info">
                            Operators will be able to log in and handle customer chats. Company admins can manage operators for their company.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="create-operator-btn">Create Operator</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Operator Modal -->
    <div class="modal fade" id="editOperatorModal" tabindex="-1" aria-labelledby="editOperatorModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editOperatorModalLabel">Edit Operator</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-operator-form">
                        <input type="hidden" id="edit-operator-id">
                        <div class="mb-3">
                            <label for="edit-operator-username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="edit-operator-username" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-operator-display-name" class="form-label">Display Name</label>
                            <input type="text" class="form-control" id="edit-operator-display-name">
                        </div>
                        <div class="mb-3">
                            <label for="edit-operator-name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="edit-operator-name">
                            <div class="form-text">Full name of the operator (optional)</div>
                        </div>
                        <div class="mb-3">
                            <label for="edit-operator-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="edit-operator-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-operator-role" class="form-label">Role</label>
                            <select class="form-select" id="edit-operator-role">
                                <option value="operator">Operator</option>
                                <option value="company_admin">Company Admin</option>
                                <option value="superadmin" class="superadmin-only">Superadmin</option>
                            </select>
                        </div>
                        <div class="mb-3" id="edit-company-selection-container">
                            <label for="edit-operator-company" class="form-label">Company</label>
                            <select class="form-select" id="edit-operator-company" required>
                                <option value="">Select a company</option>
                                <!-- Companies will be populated dynamically -->
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="reset-password-btn" data-bs-toggle="modal" data-bs-target="#resetPasswordModal">Reset Password</button>
                    <button type="button" class="btn btn-primary" id="save-operator-btn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resetPasswordModalLabel">Reset Operator Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="reset-password-form">
                        <input type="hidden" id="reset-password-operator-id">
                        <div class="mb-3">
                            <label for="reset-password-new" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="reset-password-new" required>
                        </div>
                        <div class="mb-3">
                            <label for="reset-password-confirm" class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="reset-password-confirm" required>
                        </div>
                        <div class="alert alert-warning">
                            <strong>Warning:</strong> This will reset the operator's password immediately. The operator will need to use this new password for their next login.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirm-reset-password-btn">Reset Password</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Company Modal -->
    <div class="modal fade" id="createCompanyModal" tabindex="-1" aria-labelledby="createCompanyModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createCompanyModalLabel">Create New Company</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="create-company-form">
                        <div class="mb-3">
                            <label for="company-name" class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="company-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="company-description" class="form-label">Description</label>
                            <textarea class="form-control" id="company-description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="company-website" class="form-label">Website</label>
                            <input type="url" class="form-control" id="company-website">
                        </div>
                        <div class="alert alert-info">
                            After creating a company, you can add company admins and operators to it.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="create-company-btn">Create Company</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Company Modal -->
    <div class="modal fade" id="editCompanyModal" tabindex="-1" aria-labelledby="editCompanyModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editCompanyModalLabel">Edit Company</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-company-form">
                        <input type="hidden" id="edit-company-id">
                        <div class="mb-3">
                            <label for="edit-company-name" class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="edit-company-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-company-description" class="form-label">Description</label>
                            <textarea class="form-control" id="edit-company-description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="edit-company-website" class="form-label">Website</label>
                            <input type="url" class="form-control" id="edit-company-website">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-company-btn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Creation Modal -->
    <div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="taskModalLabel">Create New Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="task-form">
                        <input type="hidden" id="conversation-id">
                        <input type="hidden" id="parent-task-id">

                        <!-- Parent Task Info (only shown for follow-up tasks) -->
                        <div id="parent-task-info-modal" class="alert alert-info mb-3" style="display: none;">
                            <p class="mb-0"><strong>Creating follow-up task for:</strong> <span id="parent-task-title-modal"></span></p>
                        </div>

                        <div class="mb-3">
                            <label for="task-title-input" class="form-label">Title</label>
                            <input type="text" class="form-control" id="task-title-input" required>
                        </div>

                        <div class="mb-3">
                            <label for="task-description-input" class="form-label">Description</label>
                            <textarea class="form-control" id="task-description-input" rows="3" required></textarea>
                            <div class="form-text">Supports Markdown formatting: **bold**, *italic*, [links](url), - list items, # headings</div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="task-due-date-input" class="form-label">Due Date</label>
                                <input type="date" class="form-control" id="task-due-date-input" required>
                            </div>
                            <div class="col-md-6">
                                <label for="task-priority-input" class="form-label">Priority</label>
                                <select class="form-select" id="task-priority-input" required>
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="task-assignee-input" class="form-label">Assignee</label>
                            <select class="form-select" id="task-assignee-input">
                                <option value="">Select an assignee</option>
                                <!-- Assignees will be populated dynamically -->
                            </select>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">Contact Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="contact-name-input" class="form-label">Name</label>
                                            <input type="text" class="form-control" id="contact-name-input">
                                            <div class="form-text text-danger" id="name-missing" style="display: none;">
                                                <i class="bi bi-exclamation-triangle"></i> Name is missing
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="contact-email-input" class="form-label">Email</label>
                                            <input type="email" class="form-control" id="contact-email-input">
                                            <div class="form-text text-danger" id="email-missing" style="display: none;">
                                                <i class="bi bi-exclamation-triangle"></i> Email is missing
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="contact-phone-input" class="form-label">Phone</label>
                                            <input type="tel" class="form-control" id="contact-phone-input">
                                            <div class="form-text text-danger" id="phone-missing" style="display: none;">
                                                <i class="bi bi-exclamation-triangle"></i> Phone is missing
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-task-btn">Create Task</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Information Edit Modal -->
    <div class="modal fade" id="contactInfoModal" tabindex="-1" aria-labelledby="contactInfoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="contactInfoModalLabel">Edit User Contact Information</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="contact-info-form">
                        <input type="hidden" id="contact-info-session-id">

                        <div class="mb-3">
                            <label for="edit-name-input" class="form-label">Name</label>
                            <input type="text" class="form-control" id="edit-name-input">
                        </div>

                        <div class="mb-3">
                            <label for="edit-email-input" class="form-label">Email</label>
                            <input type="email" class="form-control" id="edit-email-input">
                        </div>

                        <div class="mb-3">
                            <label for="edit-phone-input" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="edit-phone-input">
                        </div>
                    </form>
                </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="save-contact-info-btn">Save</button>
    </div>
</div>
</div>
</div>

    <!-- Load Spreadsheet Modal -->
    <div class="modal fade" id="loadSheetModal" tabindex="-1" aria-labelledby="loadSheetModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loadSheetModalLabel">Load Spreadsheet</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="modal-spreadsheet-id">
                    <div class="mb-3">
                        <label for="modal-sheet-select" class="form-label">Sheet</label>
                        <select class="form-select" id="modal-sheet-select"></select>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="modal-default-sheet" checked>
                        <label class="form-check-label" for="modal-default-sheet">Use Sheet1 (default)</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="modal-load-btn">Load</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Company User Modal -->
    <div class="modal fade" id="companyUserModal" tabindex="-1" aria-labelledby="companyUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="companyUserModalLabel">Create New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="company-user-form">
                        <input type="hidden" id="company-user-id">
                        <input type="hidden" id="company-user-company-id">
                        <div class="mb-3">
                            <label for="company-user-username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="company-user-username" required>
                        </div>
                        <div class="mb-3">
                            <label for="company-user-display-name" class="form-label">Display Name</label>
                            <input type="text" class="form-control" id="company-user-display-name">
                        </div>
                        <div class="mb-3">
                            <label for="company-user-name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="company-user-name">
                            <div class="form-text">Full name of the user (optional)</div>
                        </div>
                        <div class="mb-3">
                            <label for="company-user-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="company-user-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="company-user-role" class="form-label">Role</label>
                            <select class="form-select" id="company-user-role">
                                <option value="operator">Operator</option>
                                <option value="company_admin">Company Admin</option>
                            </select>
                        </div>
                        <div id="password-fields">
                            <div class="mb-3">
                                <label for="company-user-password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="company-user-password" required>
                            </div>
                            <div class="mb-3">
                                <label for="company-user-confirm-password" class="form-label">Confirm Password</label>
                                <input type="password" class="form-control" id="company-user-confirm-password" required>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-company-user-btn">Save User</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Company User Password Modal -->
    <div class="modal fade" id="resetCompanyUserPasswordModal" tabindex="-1" aria-labelledby="resetCompanyUserPasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resetCompanyUserPasswordModalLabel">Reset User Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="reset-company-user-password-form">
                        <input type="hidden" id="reset-company-user-id">
                        <input type="hidden" id="reset-company-id">
                        <div class="mb-3">
                            <label for="reset-company-user-password" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="reset-company-user-password" required>
                        </div>
                        <div class="mb-3">
                            <label for="reset-company-user-confirm-password" class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="reset-company-user-confirm-password" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="generate-random-password">
                            <label class="form-check-label" for="generate-random-password">Generate random password</label>
                        </div>
                        <div class="alert alert-warning">
                            <strong>Warning:</strong> This will reset the user's password immediately. The user will need to use this new password for their next login.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirm-reset-company-user-password-btn">Reset Password</button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons@4.28.0/dist/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/socket.io/client-dist/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="/js/admin_parts/admin-core.js"></script>
    <script src="/js/admin_parts/admin-events.js"></script>
    <script src="/js/admin_parts/admin-chats.js"></script>
    <script src="/js/admin_parts/admin-tasks.js"></script>
    <script src="/js/admin_parts/admin-operators.js"></script>
    <script src="/js/admin_parts/admin-companies.js"></script>
</body>
</html>
